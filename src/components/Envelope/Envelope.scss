@use "../../styles/variables" as *;
@use "sass:color";

// ======================== TIMING CONFIGURATION ========================
// These should match the TIMINGS object in Envelope.jsx
$flap-duration: 0.8s;
$letter-duration: 0.9s;
$petal-delay: 0.1s; // How long after letter starts moving before petals burst
$exit-duration: 0.8s;
$expand-duration: 0.6s;
$blend-duration: 0.4s;

// Easing curves
$flap-easing: cubic-bezier(0.6, 0, 0.4, 1); // Smooth deceleration for flap
$letter-easing: cubic-bezier(0.4, 0, 0.2, 1); // Material-style ease out
$exit-easing: cubic-bezier(0.55, 0, 1, 0.45); // Accelerate off screen
$expand-easing: cubic-bezier(0.4, 0, 0.2, 1); // Material-style ease out

$envelope-color-bg: #3e2957;
$envelope-color-flap: color.adjust($color-primary, $lightness: 5%); //
$envelope-color-bottom: color.adjust($color-primary, $lightness: -3%); // bottom
$envelope-color-sides: $color-primary; // Sides

// ======================== ENVELOPE OVERLAY ========================

.envelope {
  position: fixed;
  inset: 0;
  z-index: 1000; // Above navbar(100), mobile menu(200), burger(300)
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: $envelope-color-bg;
  cursor: pointer;
  // 3D perspective for the flap rotation — applied to container so children inherit
  perspective: 1200px;
  // ENHANCEMENT: Add a subtle radial gradient, vignette, or particle effect to the backdrop
  transition: background-color 0.5s ease;

  &--revealing,
  &--letterDown,
  &--writing,
  &--expanding,
  &--blending {
    pointer-events: none;
  }

  // Fade the purple backdrop away while the letter is expanding so that when the
  // letter itself fades out there is no purple flash — the page is already underneath.
  &--expanding,
  &--blending {
    background-color: transparent;
  }
}

// ======================== ENVELOPE BODY ========================

.envelope__body {
  position: relative;
  width: 90vw;
  height: 60vw;
  max-width: 715px;
  max-height: 494px;
  // ENHANCEMENT: Add a subtle drop-shadow for depth: filter: drop-shadow(...)

  -webkit-box-shadow: 5px 5px 40px 9px rgba(0, 0, 0, 0.171);
  box-shadow: 5px 5px 40px 9px rgba(0, 0, 0, 0.171);

  // Exit: slide the whole envelope down off screen
  transition: transform $exit-duration $exit-easing;

  .envelope--body-exiting & {
    transform: translateY(100vh);
  }
}

// ======================== INNER WRAPPER (clips the letter) ========================

.envelope__inner {
  position: absolute;
  inset: 0;
  overflow: hidden;
  border-radius: 4px;

  // Allow the letter to be visible above the envelope while sliding up/down
  .envelope--revealing &,
  .envelope--letterDown & {
    overflow: visible;
  }
}

// ======================== BACK PANEL ========================

.envelope__back {
  position: absolute;
  inset: 0;
  background-color: $envelope-color-flap;
  // ENHANCEMENT: Add a subtle inner shadow or linen paper texture
  // e.g. background-image: url(...); or box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
}

.envelope__sides {
  position: absolute;
  inset: 0;
  background-color: $envelope-color-sides;
  z-index: 3;
  clip-path: polygon(50% 50%, 100% 0, 100% 100%, 0 100%, 0 0);

  // ENHANCEMENT: Add a subtle inner shadow or linen paper texture
  // e.g. background-image: url(...); or box-shadow: inset 0 0 30px rgba(0,0,0,0.1);
}

// ======================== LETTER ========================

.envelope__letter {
  position: absolute;
  top: 8%;
  left: 6%;
  right: 6%;
  bottom: 8%;
  background-color: $color-bg;
  border-radius: 2px;
  z-index: 2; // Between back and front
  display: flex;
  align-items: center;
  justify-content: center;

  // Slide up animation — the letter emerges from the envelope
  // ENHANCEMENT: Add rotation or scale during the slide for a more dynamic feel
  // e.g. transform: translateY(...) rotate(-2deg) scale(1.02);
  transition:
    transform $letter-duration $letter-easing,
    z-index 0s,
    opacity $letter-duration $letter-easing calc($letter-duration * 1.2);

  .envelope--revealing & {
    // Slide fully above the envelope — visible because __inner switches to overflow:visible
    transform: translateY(calc(-105%));
  }

  .envelope--letterDown & {
    // Slide back to rest on top of the envelope, above the front/sides panels
    transform: translateY(0);
    z-index: 4;
  }
}

// ======================== LETTER CONTENT ========================
// Mirrors Landing's flex-column centering so YoureInvited is the same size
// and position when the letter is fullscreen as it is on the landing page.

.envelope__letter-content {
  width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

// Background layer — starts at letter position, always expands to fullscreen
.envelope__letter-bg {
  position: fixed;
  top: var(--letter-top);
  left: var(--letter-left);
  width: var(--letter-width);
  height: var(--letter-height);
  right: auto;
  bottom: auto;
  background-color: $color-bg;
  border-radius: 2px;
  z-index: 998;
  box-shadow: 5px 5px 40px 9px rgba(0, 0, 0, 0.171);
  transition:
    top $expand-duration $expand-easing,
    left $expand-duration $expand-easing,
    width $expand-duration $expand-easing,
    height $expand-duration $expand-easing,
    border-radius $expand-duration $expand-easing,
    box-shadow $expand-duration $expand-easing,
    opacity $blend-duration ease;

  &--expanded {
    top: 0;
    left: 0;
    width: 100vw;
    height: 100dvh;
    border-radius: 0;
    box-shadow: none;
  }

  &--fading {
    opacity: 0;
  }
}

// Content layer — moves to match Landing's YoureInvited position
.envelope__letter--detached {
  position: fixed;
  top: var(--letter-top);
  left: var(--letter-left);
  width: var(--letter-width);
  height: var(--letter-height);
  right: auto;
  bottom: auto;
  z-index: 999;
  transform: none;
  transition:
    top $expand-duration $expand-easing,
    left $expand-duration $expand-easing,
    width $expand-duration $expand-easing,
    height $expand-duration $expand-easing,
    border-radius $expand-duration $expand-easing,
    opacity $blend-duration ease;
}

.envelope__letter--expanded {
  top: var(--expand-top, 0);
  left: var(--expand-left, 0);
  width: var(--expand-width, 100vw);
  height: var(--expand-height, 100dvh);
  border-radius: 0;
  background: transparent;
}

.envelope__letter--fading {
  opacity: 0;
}

// ======================== FRONT PANEL (trapezoid covering bottom of letter) ========================

.envelope__front {
  position: absolute;
  inset: 0;
  background-color: $envelope-color-bottom;
  // Trapezoid shape: point at center-top, full width at bottom
  clip-path: polygon(0% 100%, 50% 35%, 100% 100%);
  z-index: 3; // Above the letter
  // ENHANCEMENT: Add a subtle gradient or linen texture overlay
}

// ======================== FLAP (triangular top — 3D rotation) ========================

.envelope__flap {
  position: absolute;
  top: 1px;
  left: 0;
  right: 0;
  // Height matches the envelope body so the triangle can reach past center
  height: 100%;
  background-color: $envelope-color-flap;
  // Triangle: full width at top, point at center
  clip-path: polygon(0% 0%, 50% 55%, 100% 0%);
  // Rotate from the top edge for the "fold open" effect
  transform-origin: top center;
  transform: rotateX(0deg);
  transition:
    transform $flap-duration $flap-easing,
    z-index 0s linear calc($flap-duration * 0.5); // Change z-index halfway through flap animation
  z-index: 4; // Above everything when closed
  // ENHANCEMENT: Add a shadow that moves/grows as the flap rotates open
  // e.g. filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));

  .envelope--opening &,
  .envelope--revealing &,
  .envelope--letterDown &,
  .envelope--writing &,
  .envelope--expanding &,
  .envelope--blending & {
    transform: rotateX(180deg);
    z-index: 1; // Once open, flap drops behind
  }
}

// ======================== SEAL (wax stamp) ========================

// Separate X/rotation (linear drift) from Y (parabolic arc) using two nested elements
// The outer .envelope__seal handles X + rotation with a linear timing
// The inner img handles Y with an ease-in curve (slow at peak, accelerates down)

@keyframes seal-x {
  0% {
    transform: translateX(-50%);
  }
  100% {
    transform: translateX(50%);
  }
}

@keyframes seal-y {
  0% {
    transform: translateY(-60%) rotate(0deg);
  }
  35% {
    // Peak of the throw — hangs in the air
    transform: translateY(-130%) rotate(20deg);
  }
  100% {
    // Falls down off screen
    transform: translateY(100vh) rotate(35deg);
  }
}

.envelope__seal {
  position: absolute;
  // Position at the tip of the flap triangle (~55% down, centered)
  top: calc(55%);
  left: 50%;
  width: 18%; // Proportional to envelope body
  transform: translateX(-50%);
  z-index: 5; // On top of flap

  img {
    display: block;
    width: 100%;
    transform: translateY(-60%);
  }

  .envelope--opening &,
  .envelope--revealing &,
  .envelope--letterDown &,
  .envelope--writing &,
  .envelope--expanding &,
  .envelope--blending & {
    // Outer: horizontal drift + rotation (linear)
    animation: seal-x 1s linear forwards;

    img {
      // Inner: vertical arc (ease-in = hangs at peak, accelerates down)
      animation: seal-y 1s ease-in forwards;
    }
  }
}

// ======================== PETALS (rest on letter, burst on reveal) ========================
// 3 nested elements split X / Y / rotation for independent easing (same pattern as the seal).
// Outer: X burst (ease-out = fast burst, decelerates) + z-index step
// Middle: Y arc (ease-in = hangs at peak, accelerates down — like a thrown ball)
// Inner img: rotation (linear)

// Horizontal burst — fast outward, then decelerates
@keyframes petal-x {
  0% {
    transform: translateX(var(--petal-x));
  }
  100% {
    transform: translateX(calc(var(--petal-x) + var(--petal-burst-x)));
  }
}

// Vertical arc — kick up to peak, hang, then accelerate down off screen
@keyframes petal-y {
  0% {
    transform: translateY(var(--petal-y));
  }
  20% {
    // Peak — floats here momentarily thanks to ease-in timing
    transform: translateY(calc(var(--petal-y) + var(--petal-peak-y)));
  }
  100% {
    // Fall off screen (100vh from envelope top = always past viewport bottom)
    transform: translateY(100vh);
  }
}

// Z-index step — start behind envelope, pop to front once falling
@keyframes petal-z {
  0%,
  19% {
    z-index: 2;
  }
  20%,
  100% {
    z-index: 6;
  }
}

@keyframes petal-spin {
  from {
    transform: rotate(var(--petal-rot-from));
  }
  to {
    transform: rotate(var(--petal-rot-to));
  }
}

.envelope__petals {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 2; // Same as letter — DOM order puts petals on top, but under sides/front (z3)
  overflow: visible;
}

// Outer: resting position + X burst + z-index step
.envelope__petal {
  position: absolute;
  top: 0;
  left: 50%;
  z-index: 2;
  // Resting position
  transform: translateX(var(--petal-x));

  .envelope--revealing &,
  .envelope--letterDown &,
  .envelope--expanding &,
  .envelope--blending & {
    animation:
      petal-x var(--petal-duration) ease-out
        calc($petal-delay + var(--petal-delay)) forwards,
      petal-z var(--petal-duration) step-end
        calc($petal-delay + var(--petal-delay)) forwards;
  }
}

// Middle: Y arc (ease-in = slow at peak, accelerates into fall)
.envelope__petal-y {
  transform: translateY(var(--petal-y));

  .envelope--revealing &,
  .envelope--letterDown &,
  .envelope--expanding &,
  .envelope--blending & {
    animation: petal-y var(--petal-duration) ease-in
      calc($petal-delay + var(--petal-delay)) forwards;
  }
}

// Inner: rotation
.envelope__petal img {
  display: block;
  user-select: none;
  -webkit-user-drag: none;
  transform: rotate(var(--petal-rot-from));

  .envelope--revealing &,
  .envelope--letterDown &,
  .envelope--expanding &,
  .envelope--blending & {
    animation: petal-spin var(--petal-duration) linear
      calc($petal-delay + var(--petal-delay)) forwards;
  }
}

// ======================== RESPONSIVE ========================

@media (max-width: $breakpoint-mobile) {
  .envelope__body {
    width: 92vw;
    height: 65vw;
  }

  .envelope__letter-names {
    font-size: 2em;
  }
}
